<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <title>Hausstrom</title>
    <meta name="esp32_15" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link
      href="//fonts.googleapis.com/css?family=Raleway:400,300,600"
      rel="stylesheet"
      type="text/css"
    />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha1/css/bootstrap.min.css"
      integrity="sha384-r4NyP46KrjDleawBgD5tp8Y7UzmLA05oM1iAEQ17CSuDqnUK2+k9luXQOfXJCJ4I"
      crossorigin="anonymous"
    />
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/canvasjs/1.7.0/canvasjs.js"
    ></script>

    <style>
      body { background: #1a1a2e; color: #e0e0e0; }
      .card { background: #16213e; border: 1px solid #0f3460; border-radius: 12px; }
      .val-big   { font-size: 3.8rem; font-weight: 600; line-height: 1; }
      .val-unit  { font-size: 1.4rem; color: #aaa; }
      .val-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: #888; margin-bottom: 0.2rem; }
      .val-sub   { font-size: 0.85rem; color: #666; margin-top: 0.3rem; }
      .col-consume { color: #ff6b35; }
      .col-export  { color: #4caf50; }
      .col-idle    { color: #888; }
      .kwh-big { font-size: 2rem; font-weight: 600; }
      .err-badge { display: inline-block; padding: 0.1rem 0.5rem; border-radius: 999px; font-size: 0.75rem; background: #333; color: #666; }
      .err-badge.err { background: #5c1a1a; color: #ff6b6b; }
      .sys-info { font-size: 0.72rem; color: #555; }
    </style>

    <script type="text/javascript">
      var ws = 0;
      var last_msg = 0;
      var chart;

      // Server-driven history: keyed by monotonic minute index
      var histData        = {};
      var histWriteIdx    = 0;
      var histReadIdx     = 0;
      // Tracks the wi value at last successful fetch; prevents re-fetching
      // when nothing changed and guards against duplicate in-flight requests.
      var lastFetchedWi   = 0;

      // Two chart series: consuming (>0 orange) and exporting (<0 green)
      var posPoints = [];
      var negPoints = [];

      window.onload = function () {
        chart = new CanvasJS.Chart("chartContainer", {
          backgroundColor: "#16213e",
          zoomEnabled: true,
          axisX: {
            valueFormatString: "HH:mm",
            labelFontColor: "#666",
            gridColor: "#0f3460",
            lineColor: "#0f3460",
            tickColor: "#0f3460"
          },
          axisY: {
            includeZero: true,
            title: "W",
            titleFontColor: "#555",
            labelFontColor: "#666",
            gridColor: "#0f3460",
            lineColor: "#0f3460",
            tickColor: "#0f3460",
            stripLines: [{ value: 0, color: "#445", thickness: 1 }]
          },
          data: [
            {
              name: "Bezug", showInLegend: true, legendText: "Bezug",
              type: "area", color: "rgba(255,107,53,0.65)",
              lineColor: "#ff6b35", lineThickness: 1.5, markerSize: 0,
              xValueType: "dateTime", dataPoints: posPoints
            },
            {
              name: "Einspeisung", showInLegend: true, legendText: "Einspeisung",
              type: "area", color: "rgba(76,175,80,0.65)",
              lineColor: "#4caf50", lineThickness: 1.5, markerSize: 0,
              xValueType: "dateTime", dataPoints: negPoints
            }
          ]
        });
        chart.render();
      };

      // Rebuild both chart series from histData in index order
      function rebuildChart() {
        posPoints.length = 0;
        negPoints.length = 0;
        for (var i = histReadIdx; i < histWriteIdx; i++) {
          if (!(i in histData)) continue;
          var avg = (histData[i].w_min + histData[i].w_max) / 2;
          // Compute timestamp: each index is one minute, write_idx = now
          var t = new Date(Date.now() - (histWriteIdx - i) * 60000);
          posPoints.push({ x: t, y: Math.max(avg, 0) });
          negPoints.push({ x: t, y: Math.min(avg, 0) });
        }
        chart.render();
      }

      // Fetch full history from the server (single HTTP GET, no WebSocket traffic).
      // Called on connect and whenever hist_write_idx advances (≈once per minute).
      function fetchHistory() {
        var base = location.hostname ? "http://" + location.hostname : "http://esp32_15.local";
        fetch(base + "/hist.json")
          .then(function(r) { return r.json(); })
          .then(function(h) {
            histReadIdx  = h.ri;
            histWriteIdx = h.wi;
            lastFetchedWi = h.wi;
            histData = {};
            h.d.forEach(function(entry, offset) {
              histData[h.ri + offset] = { w_min: entry[0], w_max: entry[1] };
            });
            rebuildChart();
          })
          .catch(function() { lastFetchedWi = 0; });  // allow retry on failure
      }

      function process(data) {
        var power = data["Power_W"];
        var cons  = data["Consumption_Wh"];
        var prod  = data["Production_Wh"];
        var errs  = data["sml_error"];

        // Current power
        var pwrEl = document.getElementById("power_val");
        var subEl = document.getElementById("power_sub");
        pwrEl.textContent = Math.abs(power).toFixed(0);
        if (power > 50) {
          pwrEl.className = "val-big col-consume";
          subEl.textContent = "vom Netz";
        } else if (power < -50) {
          pwrEl.className = "val-big col-export";
          subEl.textContent = "ins Netz";
        } else {
          pwrEl.className = "val-big col-idle";
          subEl.textContent = "ausgeglichen";
        }

        // Energy totals
        document.getElementById("cons_kwh").textContent = (cons / 1000).toFixed(3);
        document.getElementById("prod_kwh").textContent = (prod / 1000).toFixed(3);

        // SML error badge
        var badge = document.getElementById("sml_err");
        badge.textContent = "SML err: " + errs;
        badge.className = "err-badge" + (errs > 0 ? " err" : "");

        // Track ring-buffer boundaries; evict stale browser-side entries.
        var newWriteIdx = data["hist_write_idx"];
        var newReadIdx  = data["hist_read_idx"];
        if (newReadIdx > histReadIdx) {
          for (var i = histReadIdx; i < newReadIdx; i++) delete histData[i];
        }
        histReadIdx  = newReadIdx;
        histWriteIdx = newWriteIdx;

        // Re-fetch /hist.json only when the server has a new minute entry.
        // lastFetchedWi guards against duplicate in-flight requests.
        if (newWriteIdx > lastFetchedWi) {
          lastFetchedWi = newWriteIdx;
          fetchHistory();
        }

        // System info
        document.getElementById("sys_uptime").textContent =
          (data["millis"] / 3600000).toFixed(1) + "h";
        document.getElementById("sys_mem").textContent =
          Math.round(data["mem_free"] / 1024) + "k";
        document.getElementById("sys_ssid").textContent = data["SSID"];
        document.getElementById("sys_ip").textContent   = data["IP"];
        document.getElementById("sys_dbm").textContent  = data["wifi_dBm"];

        if (document.getElementById("show_raw").checked) {
          document.getElementById("raw").textContent = JSON.stringify(data, null, 2);
        } else {
          document.getElementById("raw").textContent = "";
        }
      }

      function repeating() {
        if (!("WebSocket" in window)) {
          alert("WebSocket NOT supported by your Browser!");
          return;
        }
        if (ws == 0 || ws.readyState >= 2) {
          var url = "ws://" + location.hostname + ":81/";
          if (location.hostname == "") url = "ws://esp32_15.local:81/";
          document.getElementById("ws_state").textContent = "…";
          ws = new WebSocket(url);
          ws.binaryType = "arraybuffer";
          last_msg = Date.now();
          ws.onopen = function () {
            document.getElementById("ws_state").textContent = "●";
            last_msg = Date.now();
            lastFetchedWi = Number.MAX_SAFE_INTEGER;  // block duplicates during fetch
            fetchHistory();
          };
          ws.onmessage = function (evt) {
            document.getElementById("ws_state").textContent = "●";
            var now = Date.now();
            process(JSON.parse(evt.data));
            document.getElementById("ws_dt").textContent = (now - last_msg) + "ms";
            last_msg = now;
          };
          ws.onerror = function () {};
          ws.onclose = function () {
            document.getElementById("ws_state").textContent = "✕";
            document.getElementById("raw").textContent = "";
          };
        } else {
          var dt = Date.now() - last_msg;
          if (dt > 5000) ws.close();
          document.getElementById("ws_dt").textContent = dt + "ms";
        }
      }
      window.setInterval(repeating, 1000);
    </script>
  </head>

  <body>
    <div class="container-fluid py-3" style="max-width:520px">

      <!-- Header -->
      <div class="d-flex align-items-center mb-3">
        <h5 class="mb-0 me-auto">Hausstrom</h5>
        <span id="sml_err" class="err-badge me-2">SML err: —</span>
        <span id="ws_state" style="font-size:1rem">…</span>
      </div>

      <!-- Current power -->
      <div class="card p-3 mb-3 text-center">
        <div class="val-label">Aktuelle Leistung</div>
        <div>
          <span class="val-big col-idle" id="power_val">—</span>
          <span class="val-unit"> W</span>
        </div>
        <div class="val-sub" id="power_sub">—</div>
      </div>

      <!-- Energy totals -->
      <div class="row g-2 mb-3">
        <div class="col-6">
          <div class="card p-3 text-center">
            <div class="val-label">Bezug</div>
            <div>
              <span class="kwh-big col-consume" id="cons_kwh">—</span>
              <span style="font-size:0.9rem; color:#aaa"> kWh</span>
            </div>
          </div>
        </div>
        <div class="col-6">
          <div class="card p-3 text-center">
            <div class="val-label">Einspeisung</div>
            <div>
              <span class="kwh-big col-export" id="prod_kwh">—</span>
              <span style="font-size:0.9rem; color:#aaa"> kWh</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Chart -->
      <div class="card p-2 mb-3">
        <div class="val-label ms-1 mb-1">Verlauf (bis 8 h)</div>
        <div id="chartContainer" style="height:200px; width:100%"></div>
      </div>

      <!-- Utilities -->
      <div class="d-flex align-items-center gap-2 mb-2 flex-wrap">
        <form action="/serverIndex" class="mb-0">
          <button class="btn btn-sm btn-secondary">Update</button>
        </form>
        <form action="/can" class="mb-0">
          <button class="btn btn-sm btn-secondary">CAN/SML</button>
        </form>
        <form action="/restart" class="mb-0">
          <button class="btn btn-sm btn-secondary">Restart</button>
        </form>
        <div class="form-check mb-0">
          <input class="form-check-input" type="checkbox" id="show_raw" />
          <label class="form-check-label" for="show_raw" style="font-size:0.8rem">Raw</label>
        </div>
        <span class="ms-auto sys-info">
          <span id="ws_dt"></span>
          &nbsp;up <span id="sys_uptime">—</span>
          &nbsp;<span id="sys_mem">—</span>
          &nbsp;<span id="sys_ssid">—</span>
          &nbsp;<span id="sys_ip">—</span>
          &nbsp;<span id="sys_dbm">—</span>dBm
        </span>
      </div>

      <pre id="raw" style="font-size:0.65rem; color:#555; white-space:pre-wrap;"></pre>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
      integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha1/js/bootstrap.min.js"
      integrity="sha384-oesi62hOLfzrys4LxRF63OJCXdXDipiYWBnvTl9Y9/TRlw5xlKIEHpNyvvDShgf/"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
